{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Launch EC2 - CSYE 6225 Spring 2020 & Set up Networking",

    "Parameters": {
        "EmailDomain":{
            "Type": "String",
            "Default": "test@prod.mengchen-gao.me"
        },
        "DYNAMODBNAMEA10":{
            "Type":"String",
            "Default":"DynamoDBA10"
        },
        "DYNAMODBPRKEYA10":{
            "Type":"String",
            "Default":"username"
        },
        "REGION":{
            "Description": "AWS Region",
            "Type": "String"
        },
        "AWSACCOUNTID":{
            "Description": "AWS Account ID",
            "Type": "String"
        },
        "AutoScalingMinSize":{
            "Type": "String",
            "Default": "2",
            "Description": "The min size of auto scaling group"
        },
        "AutoScalingMaxSize":{
            "Type": "String",
            "Default": "5",
            "Description": "The max size of auto scaling group"
        },
        "HostedZoneId" :{
            "Type": "String",
            "Description": "Hosted Zone Id"
        } ,
        "HostedZoneName" : {
            "Type": "String",
            "Description": "Hosted Zone Name"
        },
        "EC2TagValue":{
            "Type": "String",
            "Default": "EC2Assignment9",
            "Description": "Enter t2.micro, m1.small, or m1.large. Default is t2.micro."
        },
        "EC2InstanceTypeParameter": {
            "Type": "String",
            "Default": "t2.micro",
            "AllowedValues": ["t2.micro", "m1.small", "m1.large"],
            "Description": "Enter t2.micro, m1.small, or m1.large. Default is t2.micro."
        },
        "EC2DisableApiTermination":{
            "Description": "Protect against accidental termination",
            "Default": "false",
            "Type": "String"
        },
        "EC2AmiImageID":{
            "Description": "Customed AMI Image ID",
            "Type": "String"
        },
        "EC2RootVolumType":{
            "Description": "The volum type",
            "Default": "gp2",
            "AllowedValues":["gp2","io1","sc1","st1","standard"],
            "Type":"String"
        },
        "EC2RootVolumSize":{
            "Description": "The Volum Size",
            "Default": "20",
            "Type": "Number"
        },
        "EC2KeyPair":{
            "Description": "The Keypair of EC2 instance",
            "Default": "csye6225",
            "Type": "String"
        },
        "AvailableZone":{
            "Description": "Available Zone",
            "Default": "us-east-1a",
            "Type": "String"
        },
        "RDSEngine":{
            "Description": "The Engine",
            "Default": "MySQL",
            "Type": "String"
        },
        "RDSDBInstanceIdentifier":{
            "Description": "The DBInstanceIdentifier",
            "Default": "csye6225-spring2020",
            "Type": "String"
        },
        "RDSDBInstanceClass":{
            "Description": "The RDS DBInstanceClass",
            "Default": "db.t2.micro",
            "Type": "String"
        },
        "RDSMultiAtoZdeployment":{
            "Description": "The MultiAtoZ-deployment",
            "Default": "false",
            "Type": "String"
        },
        "RDSMasterUsername":{
            "Description": "The Master Username",
            "Default": "dbuser",
            "Type": "String"
        },
        "RDSMasterpassword":{
            "Description": "The Master Password",
            "Default": "adminAdmin123",
            "Type": "String"
        },
        "RDSPubliclyAccessible":{
            "Description": "The Publicly Accessible",
            "Default": "false",
            "Type": "String"
        },
        "RDSDBName":{
            "Description": "The DataBase Name",
            "Default": "csye6225",
            "Type": "String"
        },
        "RDSDBSubnetGroupName":{
            "Description": "The DBSubnetGroupName",
            "Default": "",
            "Type": "String"
        },
        "S3AccessControl":{
            "Description": "S3-AccessControl",
            "Default": "Private",
            "Type": "String"
        },
        "CodeDeploymentS3BucketArn":{
            "Description": "S3 for CodeDeployment",
            "Default" :"arn:aws:s3:::codedeploy.mengchen-gao.me",
            "Type" : "String"
        },
        "CodeDeployApplicationName":{
            "Description": "Application Name",
            "Default":"csye6225-webapp",
            "Type" : "String"
        },
        "VPCNAME": {
            "Description": "The stack name",
            "Default": "VPCA9",
            "Type": "String"
        },
        "IGWNAME": {
            "Description": "The Internet Gateway name",
            "Default": "InternetGatewayA9",
            "Type": "String"
        },
        "PUBLICROUTETABLENAME": {
            "Description": "The Public Route Table name",
            "Default": "PublicRTA9",
            "Type": "String"
        },
        "VPCCIDRBLOCK": {
            "Description": "CIDRBlock id",
            "Default": "10.192.0.0/16",
            "Type": "String"
        },
        "Subnet1CIDRBLOCK":{
            "Description": "CIDRBlock id",
            "Default": "10.192.10.0/24",
            "Type": "String"
        },
        "Subnet2CIDRBLOCK":{
            "Description": "CIDRBlock id",
            "Default": "10.192.11.0/24",
            "Type": "String"
        },
        "Subnet3CIDRBLOCK":{
            "Description": "CIDRBlock id",
            "Default": "10.192.20.0/24",
            "Type": "String"
        },
        "AWSREGION1":{
            "Description": "region 1",
            "Type": "String"
          },
          "AWSREGION2":{
            "Description": "region 2",
            "Type": "String"
          },
          "AWSREGION3":{
            "Description": "region 3",
            "Type": "String"
          }
    },
    "Resources": {
        "SQSQueue":{
            "Type" : "AWS::SQS::Queue",
            "Properties" : {
                "QueueName" : "SQSQueueA10",
                "ReceiveMessageWaitTimeSeconds" : "20"
                }
        },
        "SNSTOPIC":{
            "Type" : "AWS::SNS::Topic",
            "Properties" : {
                "Subscription" : [ {
                    "Endpoint" : {
                        "Fn::GetAtt":[
                            "LambdaFunction",
                            "Arn"
                        ]
                    },
                    "Protocol" : "lambda"
                } ],
                "TopicName" : "SNSTopicA10"
            }
        },
        "LambdaFunction":{  
            "Type" : "AWS::Lambda::Function",
            "Properties" : {
                "Code" : {
                    "ZipFile" : "echo helloworld"
                },
                "Environment" : {
                    "Variables" : {
                        "DYNAMODB_NAME" : {"Ref" : "DYNAMODBNAMEA10"}, 
                        "DYNAMODB_PR_KEY" : {"Ref" : "DYNAMODBPRKEYA10"},
                        "SENDER" : {"Ref" : "EmailDomain"}
                    }
                },
                "FunctionName" : "LambdaFunctionA10",
                "Handler" : "EmailNotification::handleRequest",
                "Role" : {
                    "Fn::GetAtt":[
                        "IAMRoleForLambdaFunction",
                        "Arn"
                    ]
                },
                "Runtime" : "nodejs12.x",
                "Timeout" : "900"
            }
        },
        "IAMRoleForLambdaFunction":{
            "Type" : "AWS::IAM::Role",
            "Properties" : {
                "AssumeRolePolicyDocument" : {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "lambda.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "RoleName" : "IAMRoleForLambdaFunctionA10",
                "ManagedPolicyArns":[
                    "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess"
                ]
            }
        },
        "UploadLogForLambdaFunctionPolicy":{
            "Type" : "AWS::IAM::Policy",
            "Properties" : {
                "PolicyDocument" : {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "logs:CreateLogGroup",
                            "Resource": {
                                "Fn::Join":[
                                    "",
                                    [
                                        "arn:aws:logs:us-east-1:",
                                        {"Ref":"AWSACCOUNTID"},
                                        ":*"
                                    ]
                                ]
                            }
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource":  "*"
                        }
                    ]
                   
                },
                "PolicyName" : "AWSLambdaBasicExcutingLogRoleA10",
                "Roles" : [ {"Ref":"IAMRoleForLambdaFunction"}]
            }
        },
        "DynamoDBPolicyForLambda":{
            "Type" : "AWS::IAM::Policy",
            "Properties" :{
                "PolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "dynamodb:DescribeStream",
                                "dynamodb:GetRecords",
                                "dynamodb:GetShardIterator",
                                "dynamodb:ListStreams",
                                "dynamodb:*",
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents",
                                "ec2:DescribeSecurityGroups",
                                "ec2:DescribeSubnets",
                                "ec2:DescribeVpcs",
                                "ec2:DescribeNetworkInterfaces", 
                                "ec2:CreateNetworkInterface",
                                "ec2:DeleteNetworkInterface",
                                "sqs:ListQueues",
                                "sqs:SendMessage",
                                "ses:*"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "PolicyName" : "DynamoDBPolicyForLambdaA10",
                "Roles" : [ {"Ref":"IAMRoleForLambdaFunction"}]
            }
            
        },
        "SESFullAccessPolicy":{
            "Type" : "AWS::IAM::Policy",
            "Properties":{
                "PolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "ses:*"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "PolicyName" : "DSESFullAccessPolicyA10",
                "Roles" : [ {"Ref":"IAMRoleForLambdaFunction"}]
            }
        },
        "DynamoDBTable":{
            "Type" : "AWS::DynamoDB::Table",
            "Properties" : {
                "AttributeDefinitions" : [ 
                    {
                        "AttributeName" : {"Ref":"DYNAMODBPRKEYA10"},
                        "AttributeType" : "S" 
                    } 
                ],
                "KeySchema" : [ {
                    "AttributeName" : {"Ref":"DYNAMODBPRKEYA10"},
                    "KeyType" : "HASH"
                  } 
                ],
                "ProvisionedThroughput" : {
                    "ReadCapacityUnits" : "5",
                    "WriteCapacityUnits" : "5"
                  },
                "TableName" : {"Ref":"DYNAMODBNAMEA10"},
                "TimeToLiveSpecification":{
                    "AttributeName" : "ExpireTTL",
                    "Enabled" : true
                  }
              }
        },
        "devDomainRecordSet":{
            "Type" : "AWS::Route53::RecordSet",
            "Properties" : {
                "AliasTarget" : 
                {
                    "DNSName" : 
                    {
                        "Fn::GetAtt":[
                            "LoadBalancer",
                            "DNSName"
                        ]
                    },
                    "EvaluateTargetHealth" : false,
                    "HostedZoneId" : 
                    {
                        "Fn::GetAtt":[
                            "LoadBalancer",
                            "CanonicalHostedZoneID"
                        ]
                    }
                },
                "HostedZoneId" : {"Ref":"HostedZoneId"},
                "Name" : {"Ref":"HostedZoneName"},
                "Type" : "A"
              }
        },
        "ASGLaunchConfiguration":{
            "Type" : "AWS::AutoScaling::LaunchConfiguration",
            "Properties" : {
                "AssociatePublicIpAddress" : true,
                "IamInstanceProfile" : {"Ref":"EC2IAMInstanceProfile"},
                "ImageId" : {"Ref":"EC2AmiImageID"},
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeType": {"Ref":"EC2RootVolumType"},
                            "VolumeSize": {"Ref": "EC2RootVolumSize"}
                        }
                    }
                ],
                "InstanceType": {
                    "Ref": "EC2InstanceTypeParameter"
                },
                "KeyName": {"Ref":"EC2KeyPair"},
                "LaunchConfigurationName" : "asg_launch_config",
                "SecurityGroups" : [
                    {
                        "Fn::GetAtt": [
                            "EC2SecurityGroup",
                            "GroupId"
                        ]
                    }
                ],
                "UserData" : {
                    "Fn::Base64": {
                      "Fn::Join": [
                        "",
                        [
                            "#!/bin/bash -v \n",
                            "set -e -x \n",
                            "sudo mkdir env \n" ,
                            "sudo su \n",
                            "echo export #!/bin/bash -v  >> env/properties.sh \n",
                            "echo export 'PROFILE_NAME=AWS' >> env/properties.sh \n",
                            "echo export 'RDS_MYSQL_DB_HOST=",{
                                "Fn::GetAtt":[
                                    "RDS",
                                    "Endpoint.Address"
                                ]
                            },"'"," >> env/properties.sh \n",
                            "echo export 'RDS_MYSQL_DB_PORT=",
                            {
                                "Fn::GetAtt":[
                                    "RDS",
                                    "Endpoint.Port"
                                ]
                            },"'"," >> env/properties.sh \n",
                            "echo export 'RDS_MYSQL_DB_USERNAME=",{"Ref":"RDSMasterUsername"},"'"," >> env/properties.sh \n",
                            "echo export 'RDS_MYSQL_DB_PASSWORD=",{"Ref":"RDSMasterpassword"},"'"," >> env/properties.sh \n",
                            "echo export 'AWS_REGION=",{"Ref":"REGION"},"'"," >> env/properties.sh \n",
                            "echo export 'AWS_S3_BUCKET_NAME=",{"Ref":"S3Bucket"},"'"," >> env/properties.sh \n",
                            "echo export 'AWS_S3_BUCKET_URL=",
                            {
                                "Fn::GetAtt":[
                                    "S3Bucket",
                                    "WebsiteURL"
                                ]
                            },"'"," >> env/properties.sh \n",
                            "echo export 'AWS_S3_BUCKET_DOMAIN=",
                            {
                                "Fn::GetAtt":[
                                    "S3Bucket",
                                    "DomainName"
                                ]
                            },"'"," >> env/properties.sh \n",
                            "echo export 'AWS_SQS_QUEUE_NAME=",
                            {
                                "Fn::GetAtt":[
                                    "SQSQueue",
                                    "QueueName"
                                ]
                            },"'"," >> env/properties.sh \n",
                            "echo export 'AWS_SNS_TOPIC_ARN=",{"Ref":"SNSTOPIC"},"'"," >> env/properties.sh \n",
                            "echo export 'DOMAIN=",{"Ref":"EmailDomain"},"'"," >> env/properties.sh \n",
                            "chmod +x env/properties.sh \n",
                            "touch /dev/csye6225.log \n",
                            "chmod 777 /dev/csye6225.log \n",
                            "sudo systemctl stop tomcat8 \n"
                        ]
                      ]
                    }
                }
            }
        },
        "AutoScalingGroup":{
            "Type" : "AWS::AutoScaling::AutoScalingGroup",
            "Properties" : {
                "AutoScalingGroupName" : "asgA9",
                "Cooldown" : "300",
                "DesiredCapacity" : "2",
                "LaunchConfigurationName" : {"Ref":"ASGLaunchConfiguration"},
                "MaxSize" : {"Ref":"AutoScalingMaxSize"},
                "MinSize" : {"Ref":"AutoScalingMinSize"},
                "Tags" : [ 
                    {
                        "Key" : "Name",
                        "PropagateAtLaunch" : true,
                        "Value" : {"Ref":"EC2TagValue"}
                    }
                ],
                "TargetGroupARNs" : [ {"Ref":"LoadBalancerTargetGroup"} ],
                "VPCZoneIdentifier" : [ {"Ref":"Subnet1"}, {"Ref":"Subnet2"}, {"Ref":"Subnet3"}]
            }
        },
        "WebServerScaleUpPolicy": {
            "Type": "AWS::AutoScaling::ScalingPolicy",
            "Properties": {
              "AdjustmentType": "ChangeInCapacity",
              "AutoScalingGroupName": {
                "Ref": "AutoScalingGroup"
              },
              "Cooldown": "300",
              "ScalingAdjustment": "1"
            }
        },
        "WebServerScaleDownPolicy": {
            "Type": "AWS::AutoScaling::ScalingPolicy",
            "Properties": {
                "AdjustmentType": "ChangeInCapacity",
                "AutoScalingGroupName": {
                "Ref": "AutoScalingGroup"
                },
                "Cooldown": "300",
                "ScalingAdjustment": "-1"
            }
        },
        "CPUAlarmHigh": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
              "AlarmDescription": "Scale-up if CPU > 90% for 1 minutes",
              "MetricName": "CPUUtilization",
              "Namespace": "AWS/EC2",
              "Statistic": "Average",
              "Period": "300",
              "EvaluationPeriods": "2",
              "Threshold": "90",
              "AlarmActions": [
                {
                  "Ref": "WebServerScaleUpPolicy"
                }
              ],
              "Dimensions": [
                {
                  "Name": "AutoScalingGroupName",
                  "Value": {
                    "Ref": "AutoScalingGroup"
                  }
                }
              ],
              "ComparisonOperator": "GreaterThanThreshold"
            }
        },
        "CPUAlarmLow": {
            "Type": "AWS::CloudWatch::Alarm",
            "Properties": {
              "AlarmDescription": "Scale-down if CPU < 70% for 1 minutes",
              "MetricName": "CPUUtilization",
              "Namespace": "AWS/EC2",
              "Statistic": "Average",
              "Period": "300",
              "EvaluationPeriods": "2",
              "Threshold": "70",
              "AlarmActions": [
                {
                  "Ref": "WebServerScaleDownPolicy"
                }
              ],
              "Dimensions": [
                {
                  "Name": "AutoScalingGroupName",
                  "Value": {
                    "Ref": "AutoScalingGroup"
                  }
                }
              ],
              "ComparisonOperator": "LessThanThreshold"
            }
        },
        "LoadBalancer":{
            "Type" : "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties" : {
                "IpAddressType" : "ipv4",
                "Name" : "LoadBalancerA9",
                "Scheme" : "internet-facing",
                "SecurityGroups" : [ 
                    {
                        "Fn::GetAtt": [
                            "ELBSecurityGroup",
                            "GroupId"
                        ]
                    }
                ],
                "Subnets" : [ {"Ref":"Subnet1"}, {"Ref":"Subnet2"}, {"Ref":"Subnet3"}],
                "Tags" : [ 
                    {
                        "Key":"Name",
                        "Value":{"Ref":"EC2TagValue"}
                    } 
                ],
                "Type" : "application"
              }
        },
        "LoadBalancerListener":{
            "Type" : "AWS::ElasticLoadBalancingV2::Listener",
            "Properties" : {
                "DefaultActions" : [ 
                    {
                    "TargetGroupArn" : {"Ref":"LoadBalancerTargetGroup"},
                    "Type" : "forward"
                    }
                 ],
                "LoadBalancerArn" : {"Ref":"LoadBalancer"},
                "Port" : 80,
                "Protocol" : "HTTP"
            }
        },
        "LoadBalancerTargetGroup":{
            "Type" : "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties" : {
                "HealthCheckIntervalSeconds" : 10,
                "HealthCheckPath" : "/",
                "HealthCheckPort" : "traffic-port",
                "HealthCheckProtocol" : "HTTP",
                "HealthCheckTimeoutSeconds" : 5,
                "HealthyThresholdCount" : 5,
                "Name" : "TargetGroupA9",
                "Port" : 8080,
                "Protocol" : "HTTP",
                "TargetType" : "instance",
                "UnhealthyThresholdCount" : 2,
                "VpcId" : {"Ref":"VPC"}
            }
        },
        "ELBSecurityGroup":{
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "VpcId": {
                    "Ref":"VPC"
                },
                "GroupName": "ELBsgA9",
                "GroupDescription": "Elastic Load Balancer SecurityGroup",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "80",
                        "ToPort": "80",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "443",
                        "ToPort": "443",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "8080",
                        "ToPort": "8080",
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "3000",
                        "ToPort": "3000",
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "EC2SecurityGroup":{
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "VpcId": {
                    "Ref":"VPC"
                },
                "GroupName": "EC2sgA9",
                "GroupDescription": "ec2 SecurityGroup",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "80",
                        "ToPort": "80",
                        "SourceSecurityGroupId":{
                            "Fn::GetAtt": [
                                "ELBSecurityGroup",
                                "GroupId"
                            ]
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "SourceSecurityGroupId":{
                            "Fn::GetAtt": [
                                "ELBSecurityGroup",
                                "GroupId"
                            ]
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "443",
                        "ToPort": "443",
                        "SourceSecurityGroupId":{
                            "Fn::GetAtt": [
                                "ELBSecurityGroup",
                                "GroupId"
                            ]
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "8080",
                        "ToPort": "8080",
                        "SourceSecurityGroupId":{
                            "Fn::GetAtt": [
                                "ELBSecurityGroup",
                                "GroupId"
                            ]
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "3000",
                        "ToPort": "3000",
                        "SourceSecurityGroupId":{
                            "Fn::GetAtt": [
                                "ELBSecurityGroup",
                                "GroupId"
                            ]
                        }
                    }
                ]
            }
        },
        "EC2IAMInstanceProfile":{
            "Type" : "AWS::IAM::InstanceProfile",
            "Properties" : {
                "InstanceProfileName" : "EC2Profile",
                "Path" : "/",
                "Roles" : [
                    {"Ref":"CodeDeployEC2ServiceRole"}
                ]
            }
        },      
        "EC2IAMPolicy":{
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "CodeDeployEC2S3",
                "PolicyDocument": {
                    "Version" : "2012-10-17",
                    "Statement": [ 
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:GetObject",
                                "s3:DeleteObject",
                                "s3:PutObject",
                                "s3:ListBucket"
                            ],
                            "Resource": [
                                {
                                    "Fn::GetAtt": [
                                        "S3Bucket",
                                        "Arn"
                                    ]
                                },
                                {
                                    "Fn::Join":[
                                        "",
                                        [
                                            {
                                            "Fn::GetAtt": [
                                                "S3Bucket",
                                                "Arn"
                                            ]
                                            },"/*"
                                        ]
                                    ]   
                                }
                            ]
                                
                        }
                    ]
                },
                "Roles": [  {"Ref":"CodeDeployEC2ServiceRole"}]
            }
        },
        "S3Bucket":{
            "Type" : "AWS::S3::Bucket",
            "Properties" : {
                "AccessControl" : {"Ref":"S3AccessControl"},
                "BucketEncryption" : {
                    "ServerSideEncryptionConfiguration":[
                        {   
                            "ServerSideEncryptionByDefault":{
                                "SSEAlgorithm" : "aws:kms" 
                            }
                        }
                    ]
                },
                "LifecycleConfiguration" : {
                    "Rules": [
                        {
                            "Id": "30day",
                            "Status": "Enabled",
                            "Prefix":"",
                            "ExpirationInDays":"365",
                            "Transitions":[
                                {
                                "StorageClass":"STANDARD_IA",
                                "TransitionInDays":"30"
                            }
                        ]
                            
                        }
                     ]
                }
            }
        },           
        "RDSDBSecurityGroup":{
            "Type": "AWS::EC2::SecurityGroup",
        	"Properties": {
        	"Tags" :  [{"Key" : "Name", "Value" : "RDSSG"}],
            "GroupName":"csye6225-rds",
            "GroupDescription": "database",
            "VpcId":{"Ref":"VPC"},
            "SecurityGroupIngress": [
                {
                    "IpProtocol": "tcp",
                    "FromPort": "3306",
                    "ToPort": "3306",
                    "SourceSecurityGroupId" : {"Ref":"EC2SecurityGroup"}
                }
            ]
        	}
        },
        "RDS":{
            "Type" : "AWS::RDS::DBInstance",
            "Properties" : {
                "AllocatedStorage" : "100",
                "DBInstanceClass" : {"Ref":"RDSDBInstanceClass"},
                "DBInstanceIdentifier" : {"Ref":"RDSDBInstanceIdentifier"},
                "VPCSecurityGroups" : [
                    {"Ref":"RDSDBSecurityGroup"}
                ],
                "DBName" : {"Ref":"RDSDBName"},
                "Engine":{"Ref":"RDSEngine"},
                "MasterUsername" : {"Ref":"RDSMasterUsername"},
                "MasterUserPassword" : {"Ref":"RDSMasterpassword"},
                "MultiAZ" : {"Ref":"RDSMultiAtoZdeployment"},
                "PubliclyAccessible" : {"Ref":"RDSPubliclyAccessible"},
                "DBSubnetGroupName" : {"Ref":"SubnetGroup"}
            }
        },
        "SubnetGroup":{
            "Type" : "AWS::RDS::DBSubnetGroup",
            "Properties" : {
                "DBSubnetGroupDescription" : "String",
                "DBSubnetGroupName" : "RDSSubnetGroup",
                "SubnetIds" : [ 
                    {"Ref":"Subnet1"},
                    {"Ref":"Subnet2"},
                    {"Ref":"Subnet3"}
                 ],
                "Tags" : [ {
                    "Key" : "Name",
                    "Value" : "rds-SubnetGroup"
                  } ]
              }
        }, 
        "CodeDeployEC2S3Policy":{
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "CodeDeploy-EC2-S3",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": [
                                "s3:Get*",
                                "s3:List*"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                {
                                    "Ref":"CodeDeploymentS3BucketArn"
                                },
                                {
                                    "Fn::Join":[
                                        "",
                                        [
                                            {"Ref":"CodeDeploymentS3BucketArn"},
                                            "/*"
                                        ]
                                    ]   
                                }
                            ]
                        }
                    ]
                },
                "Roles": [  {"Ref":"CodeDeployEC2ServiceRole"}]
            }
        },
        "circleciec2ami":{
            "Type":"AWS::IAM::Policy",
            "Properties":{
               "PolicyDocument":{
                  "Version":"2012-10-17",
                  "Statement":[
                     {
                        "Effect":"Allow",
                        "Action":[
                           "ec2:AttachVolume",
                           "ec2:AuthorizeSecurityGroupIngress",
                           "ec2:CopyImage",
                           "ec2:CreateImage",
                           "ec2:CreateKeypair",
                           "ec2:CreateSecurityGroup",
                           "ec2:CreateSnapshot",
                           "ec2:CreateTags",
                           "ec2:CreateVolume",
                           "ec2:DeleteKeyPair",
                           "ec2:DeleteSecurityGroup",
                           "ec2:DeleteSnapshot",
                           "ec2:DeleteVolume",
                           "ec2:DeregisterImage",
                           "ec2:DescribeImageAttribute",
                           "ec2:DescribeImages",
                           "ec2:DescribeInstances",
                           "ec2:DescribeInstanceStatus",
                           "ec2:DescribeRegions",
                           "ec2:DescribeSecurityGroups",
                           "ec2:DescribeSnapshots",
                           "ec2:DescribeSubnets",
                           "ec2:DescribeTags",
                           "ec2:DescribeVolumes",
                           "ec2:DetachVolume",
                           "ec2:GetPasswordData",
                           "ec2:ModifyImageAttribute",
                           "ec2:ModifyInstanceAttribute",
                           "ec2:ModifySnapshotAttribute",
                           "ec2:RegisterImage",
                           "ec2:RunInstances",
                           "ec2:StopInstances",
                           "ec2:TerminateInstances"
                        ],
                        "Resource":"*"
                     }
                  ]
               },
               "PolicyName":"circleci-ec2-ami",
               "Users":[
                  "circleci"
               ]
            }
        },
        "CircleCIUploadToS3Policy":{
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "CircleCI-Upload-To-S3",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:PutObject",
                                "s3:Get*",
                                "s3:List*"
                            ],
                            "Resource": [
                                {
                                    "Ref":"CodeDeploymentS3BucketArn"
                                },
                                {
                                    "Fn::Join":[
                                        "",
                                        [
                                            {"Ref":"CodeDeploymentS3BucketArn"},
                                            "/*"
                                        ]
                                    ]   
                                }
                            ]
                        }
                    ]
                },
                "Users":[
                    "circleci"
                ]
            }
        },
        "CircleCICodeDeployPolicy":{
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "CircleCI-Code-Deploy",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                      {
                        "Effect": "Allow",
                        "Action": [
                          "codedeploy:RegisterApplicationRevision",
                          "codedeploy:GetApplicationRevision"
                        ],
                        "Resource": [
                            {   
                                "Fn::Join":[
                                    "",
                                    [
                                        "arn:aws:codedeploy:",
                                        {"Ref":"REGION"},":",
                                        {"Ref":"AWSACCOUNTID"},
                                        ":application:",
                                        {"Ref":"CodeDeployApplicationName"}
                                    ]
                                ]
                            }
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Action": [
                          "codedeploy:CreateDeployment",
                          "codedeploy:GetDeployment"
                        ],
                        "Resource": [
                          "*"
                        ]
                      },
                      {
                        "Effect": "Allow",
                        "Action": [
                          "codedeploy:GetDeploymentConfig"
                        ],
                        "Resource": [
                            {   
                                "Fn::Join":[
                                    "",
                                    [
                                        "arn:aws:codedeploy:",
                                        {"Ref":"REGION"},":",
                                        {"Ref":"AWSACCOUNTID"},
                                        ":deploymentconfig:CodeDeployDefault.OneAtATime"
                                    ]
                                ]
                            },
                            {   
                                "Fn::Join":[
                                    "",
                                    [
                                        "arn:aws:codedeploy:",
                                        {"Ref":"REGION"},":",
                                        {"Ref":"AWSACCOUNTID"},
                                        ":deploymentconfig:CodeDeployDefault.HalfAtATime"
                                    ]
                                ]
                            },
                            {   
                                "Fn::Join":[
                                    "",
                                    [
                                        "arn:aws:codedeploy:",
                                        {"Ref":"REGION"},":",
                                        {"Ref":"AWSACCOUNTID"},
                                        ":deploymentconfig:CodeDeployDefault.AllAtOnce"
                                    ]
                                ]
                            }
                        ]
                      }
                    ]
                },
                "Users":[
                    "circleci"
                ]  
            }
        },
        "CodeDeployEC2ServiceRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "RoleName":"CodeDeployEC2ServiceRole",
               "AssumeRolePolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                    {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "ec2.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                    }
                    ]
               },
               "ManagedPolicyArns":[
                "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy",
                "arn:aws:iam::aws:policy/AmazonSNSFullAccess",
                "arn:aws:iam::aws:policy/AmazonSESFullAccess",
                "arn:aws:iam::aws:policy/AmazonSQSFullAccess"

                ],
                "Path":"/"
            }            
        },
        "CodeDeployServiceRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "RoleName":"CodeDeployServiceRole",
               "AssumeRolePolicyDocument":{
                    "Version": "2012-10-17",
                    "Statement": [
                    {
                        "Sid": "",
                        "Effect": "Allow",
                        "Principal": {
                        "Service": "codedeploy.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                    }
                    ]
               },
               "ManagedPolicyArns":[
                "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
                ],
                "Path":"/"
            }            
        },
        "CodeDeployApplication":{
            "Type" : "AWS::CodeDeploy::Application",
            "Properties" : {
                "ApplicationName" : {"Ref":"CodeDeployApplicationName"},
                "ComputePlatform" : "Server"
              }
        },
        "CodeDeployDeploymentGroup":{
            "Type" : "AWS::CodeDeploy::DeploymentGroup",
            "Properties" : {
                "ApplicationName" : {"Ref":"CodeDeployApplication"},
                "AutoRollbackConfiguration" : {
                  "Enabled" : true,
                  "Events" : [ "DEPLOYMENT_FAILURE" ]
                },
                "AutoScalingGroups" : [ 
                    {
                        "Ref":"AutoScalingGroup"
                    }
                ],
                "DeploymentConfigName" : "CodeDeployDefault.OneAtATime",
                "DeploymentGroupName" : "csye6225-webapp-deployment",
                "DeploymentStyle" : {
                    "DeploymentOption" : "WITHOUT_TRAFFIC_CONTROL",
                    "DeploymentType" : "IN_PLACE"
                  },
                "Ec2TagFilters" : [
                    {
                        "Key" : "Name",
                        "Type" : "KEY_AND_VALUE",
                        "Value" : {"Ref":"EC2TagValue"}
                    }
                 ],
                "ServiceRoleArn" : {
                    "Fn::GetAtt":[
                        "CodeDeployServiceRole",
                        "Arn"
                    ]
                }
              }
        },
        "VPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
            "CidrBlock": {
                "Ref": "VPCCIDRBLOCK"
            },
            "Tags": [
                {
                    "Key": "Name",
                    "Value": {
                        "Ref": "VPCNAME"
                    }
                }
            ]
            }
        },
        "InternetGateway": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
            "Tags": [
                {
                "Key": "Name",
                    "Value": {
                        "Ref": "IGWNAME"
                    }
                }
            ]
            }
        },
        "VPCGatewayAttachment": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                }
            }
        },
        "PublicRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "VPC"
                },
                "Tags": [
                    {
                    "Key": "Name",
                    "Value": {
                        "Ref": "PUBLICROUTETABLENAME"
                    }
                    }
                ]
            }
        },
        "PublicInternetRoute": {
            "Type": "AWS::EC2::Route",
            "DependsOn": "InternetGateway",
            "Properties": {
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                },
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                }
            }
        },
        "Subnet1": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": {
                    "Ref": "AWSREGION1"
                },
                "CidrBlock": {
                    "Ref": "Subnet1CIDRBLOCK"
                },
                "MapPublicIpOnLaunch": true,
                "VpcId": {
                    "Ref": "VPC"
                }
            }
        },
        "Subnet2": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone": {
                    "Ref": "AWSREGION2"
                },
                "CidrBlock": {
                    "Ref": "Subnet2CIDRBLOCK"
                },
                "MapPublicIpOnLaunch": true,
                "VpcId": {
                    "Ref": "VPC"
                }
            }
        },
        "Subnet3": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "AvailabilityZone":  {
                    "Ref": "AWSREGION3"
                },
                "CidrBlock": {
                    "Ref": "Subnet3CIDRBLOCK"
                },
                "MapPublicIpOnLaunch": true,
                "VpcId": {
                    "Ref": "VPC"
                }
            }
        },     
        "SubnetRouteTable1": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "Subnet1"
                }
            }
        },
        "SubnetRouteTable2": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "Subnet2"
                }
            }
        },
        "SubnetRouteTable3": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "RouteTableId": {
                    "Ref": "PublicRouteTable"
                },
                "SubnetId": {
                    "Ref": "Subnet3"
                }
            }
        }
    },
    "Outputs": {
        "VPCId":{
            "Description":"VPC",
            "Value":{
                "Ref":"VPC"
            }
          
        }
    }
  
}
